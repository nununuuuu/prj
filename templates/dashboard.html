{% extends "base.html" %}

{% block content %}

<div class="flex flex-col lg:flex-row w-full h-full">

    <div class="w-full lg:w-80 bg-white border-r border-gray-200 flex-shrink-0 flex flex-col h-full z-10">
        <div class="p-4 border-b border-gray-100 flex items-center justify-between bg-white sticky top-0 z-10">
            <h2 class="font-bold text-gray-700 flex items-center gap-2">
                <svg class="w-4 h-4 text-blue-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M12 6V4m0 2a2 2 0 100 4m0-4a2 2 0 110 4m-6 8a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4m6 6v10m6-2a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4">
                    </path>
                </svg>
                åƒæ•¸è¨­å®š
            </h2>
            <button onclick="resetParams()" class="text-xs text-blue-500 hover:text-blue-700">é‡ç½®</button>
        </div>

        <div class="overflow-y-auto flex-1 p-4 custom-scrollbar space-y-6">
            <div class="space-y-3">
                <p class="text-xs font-bold text-gray-400 uppercase tracking-wider">åŸºæœ¬è¨­å®š</p>
                <div>
                    <label class="block text-xs font-medium text-gray-600 mb-1">è‚¡ç¥¨ä»£ç¢¼</label>
                    <input type="text" id="ticker"
                        class="w-full bg-gray-50 border border-gray-200 rounded-lg p-2.5 text-sm uppercase focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none transition font-mono"
                        placeholder="2330, 006208, NVDA">
                    <p class="text-[10px] text-gray-400 mt-1 h-3" id="tickerHint"></p>
                </div>
                <div>
                    <label class="block text-xs font-medium text-gray-600 mb-1">åˆå§‹æœ¬é‡‘</label>
                    <div class="relative">
                        <span class="absolute left-3 top-2.5 text-gray-400 text-sm">$</span>
                        <input type="number" id="cash" value="100000"
                            class="w-full bg-gray-50 border border-gray-200 rounded-lg pl-6 p-2.5 text-sm">
                    </div>
                </div>
                <div class="grid grid-cols-2 gap-2">
                    <div><label class="block text-xs font-medium text-gray-600 mb-1">é–‹å§‹æ—¥æœŸ</label><input type="date"
                            id="start_date" class="w-full bg-gray-50 border border-gray-200 rounded-lg p-2 text-xs">
                    </div>
                    <div><label class="block text-xs font-medium text-gray-600 mb-1">çµæŸæ—¥æœŸ</label><input type="date"
                            id="end_date" class="w-full bg-gray-50 border border-gray-200 rounded-lg p-2 text-xs"></div>
                </div>
            </div>
            <hr class="border-gray-100">
            <div class="space-y-3">
                <p class="text-xs font-bold text-gray-400 uppercase tracking-wider">ç­–ç•¥è¨­å®š</p>
                <div class="grid grid-cols-2 gap-3">
                    <div><label class="block text-xs font-medium text-gray-600 mb-1">çŸ­æœŸSMA</label><input type="number"
                            id="ma_short" value="10"
                            class="w-full border border-gray-200 rounded-lg p-2 text-sm text-center focus:border-blue-500 outline-none">
                    </div>
                    <div><label class="block text-xs font-medium text-gray-600 mb-1">é•·æœŸSMA</label><input type="number"
                            id="ma_long" value="60"
                            class="w-full border border-gray-200 rounded-lg p-2 text-sm text-center focus:border-blue-500 outline-none">
                    </div>
                </div>
                <div class="bg-blue-50 p-3 rounded-lg border border-blue-100">
                    <!-- [ä¿®æ­£] ä¿®å¾©æ¨™ç±¤é–‰åˆéŒ¯èª¤ -->
                    <label class="text-xs font-bold text-blue-800 mb-2 block">RSI æ¿¾ç¶²</label>
                    <div class="grid grid-cols-2 gap-x-3 gap-y-2">
                        <div class="col-span-1"><span class="text-[10px] text-gray-500 block mb-1">é€²å ´é€±æœŸ</span><input
                                type="number" id="rsi_period_entry" value="14"
                                class="w-full border border-blue-200 rounded p-1 text-xs text-center bg-white"></div>

                        <!-- [ä¿®æ­£] é è¨­æ”¹ç‚º 70 -->
                        <div class="col-span-1"><span class="text-[10px] text-gray-500 block mb-1">é€²å ´ä¸Šé™
                                (&lt;)</span><input type="number" id="rsi_buy_threshold" value="70"
                                class="w-full border border-blue-200 rounded p-1 text-sm text-center font-bold text-blue-600">
                        </div>

                        <div class="col-span-2 border-t border-blue-100 my-1"></div>
                        <div class="col-span-1"><span class="text-[10px] text-gray-500 block mb-1">å‡ºå ´é€±æœŸ</span><input
                                type="number" id="rsi_period_exit" value="14"
                                class="w-full border border-red-200 rounded p-1 text-xs text-center bg-white"></div>

                        <!-- [ä¿®æ­£] é è¨­æ”¹ç‚º 80 -->
                        <div class="col-span-1"><span class="text-[10px] text-gray-500 block mb-1">å‡ºå ´è§¸ç™¼
                                (&gt;)</span><input type="number" id="rsi_sell_threshold" value="80"
                                class="w-full border border-red-200 rounded p-1 text-sm text-center font-bold text-red-500">
                        </div>
                    </div>
                </div>
            </div>
            <hr class="border-gray-100">
            <div class="space-y-3">
                <p class="text-xs font-bold text-gray-400 uppercase tracking-wider">é¢¨éšªæ§åˆ¶</p>
                <div class="grid grid-cols-2 gap-3">
                    <div><label class="block text-xs font-medium text-gray-600 mb-1">åœæ (%)</label><input type="number"
                            id="sl_pct" value="0" step="0.5"
                            class="w-full border border-gray-200 rounded-lg p-2 text-sm text-red-600 font-bold bg-red-50 focus:bg-white transition">
                    </div>
                    <div><label class="block text-xs font-medium text-gray-600 mb-1">åœåˆ© (%)</label><input type="number"
                            id="tp_pct" value="0" step="0.5"
                            class="w-full border border-gray-200 rounded-lg p-2 text-sm text-green-600 font-bold bg-green-50 focus:bg-white transition">
                    </div>
                </div>
                <details class="group">
                    <summary
                        class="flex justify-between items-center font-medium cursor-pointer list-none text-xs text-gray-500 hover:text-gray-700">
                        <span>é€²éšï¼šäº¤æ˜“æ‰‹çºŒè²»</span><span class="transition group-open:rotate-180"><svg fill="none" height="16"
                                stroke="currentColor" stroke-width="1.5" viewBox="0 0 24 24" width="16">
                                <path d="M6 9l6 6 6-6"></path>
                            </svg></span></summary>
                    <div class="text-neutral-600 mt-2 grid grid-cols-2 gap-2 animate-fadeIn">
                        <div><label class="text-[10px]">è²·å…¥ (%)</label><input type="number" step="0.0001" id="buy_fee"
                                value="0.1425" class="w-full border rounded p-1 text-xs"></div>
                        <div><label class="text-[10px]">è³£å‡º (%)</label><input type="number" step="0.0001" id="sell_fee"
                                value="0.4425" class="w-full border rounded p-1 text-xs"></div>
                    </div>
                </details>
            </div>
            <div class="h-10"></div>
        </div>
        <div class="p-4 border-t border-gray-200 bg-gray-50 sticky bottom-0 z-10">
            <button type="button" id="runBtn" onclick="executeBacktest()"
                class="w-full bg-blue-600 hover:bg-blue-700 active:scale-95 text-white font-bold py-3 rounded-xl transition shadow-lg shadow-blue-500/30 flex justify-center items-center gap-2">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M14.752 11.168l-3.197-2.132A1 1 0 0010 9.87v4.263a1 1 0 001.555.832l3.197-2.132a1 1 0 000-1.664z">
                    </path>
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                </svg>é–‹å§‹å›æ¸¬
            </button>
        </div>
    </div>

    <div class="flex-1 bg-gray-100 h-full overflow-y-auto custom-scrollbar relative">
        <div class="max-w-7xl mx-auto p-4 lg:p-6 space-y-6">
            <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                <div class="bg-white p-5 rounded-2xl shadow-sm border border-gray-100 flex flex-col justify-between">
                    <p class="text-xs font-medium text-gray-400">å¹´åŒ–å ±é…¬ç‡ (CAGR)</p>
                    <p class="text-3xl font-bold text-gray-300 mt-1" id="res_ann_return">--%</p>
                </div>
                <div class="bg-white p-5 rounded-2xl shadow-sm border border-gray-100 flex flex-col justify-between">
                    <div class="flex justify-between items-start">
                        <p class="text-xs font-medium text-gray-400">ç¸½å ±é…¬ç‡</p>
                        <span class="text-sm font-medium bg-gray-100 text-gray-600 px-2 py-0.5 rounded-full">è²·é€²ä¸¦æŒæœ‰:
                            <span id="res_bh_return">--</span></span>
                    </div>
                    <p class="text-3xl font-bold text-gray-300 mt-1" id="res_total_return">--%</p>
                </div>

                <div
                    class="bg-gradient-to-br from-slate-600 to-slate-700 text-white p-5 rounded-2xl shadow-lg shadow-gray-400/20 flex flex-col justify-between">
                    <p class="text-xs font-medium text-blue-100">æœ€çµ‚è³‡ç”¢ (Equity)</p>
                    <p class="text-3xl font-bold mt-1 text-white" id="res_final_equity">$ --</p>
                </div>

                <div class="bg-white p-5 rounded-2xl shadow-sm border border-gray-100 flex flex-col justify-between">
                    <p class="text-xs font-medium text-gray-400">å‹ç‡ / äº¤æ˜“æ¬¡æ•¸</p>
                    <div class="flex items-baseline gap-2 mt-1">
                        <p class="text-3xl font-bold text-gray-300" id="res_win_rate">--%</p>
                        <span class="text-sm text-gray-400">(<span id="res_trades">--</span>ç­†)</span>
                    </div>
                </div>
            </div>

            <div class="bg-white p-6 rounded-2xl shadow-sm border border-gray-100">
                <div class="flex justify-between items-center mb-6">
                    <div>
                        <h3 class="font-bold text-gray-800 text-lg">è³‡ç”¢èµ°å‹¢åœ–</h3>
                    </div>
                    <div class="flex gap-2">
                        <button type="button" onclick="resetZoom()"
                            class="px-3 py-1.5 text-xs font-medium text-gray-600 bg-gray-100 rounded hover:bg-gray-200 transition">é‡ç½®ç¸®æ”¾</button>
                        <button type="button" id="lockBtn"
                            class="px-3 py-1.5 text-xs font-medium text-blue-600 bg-blue-50 border border-blue-100 rounded hover:bg-blue-100 transition">é–å®šæ›²ç·š</button>
                    </div>
                </div>
                <div class="relative w-full h-[400px] flex items-center justify-center bg-gray-50 rounded-xl border border-dashed border-gray-200"
                    id="chartContainer">
                    <div class="text-center" id="chartPlaceholder">
                        <div class="mb-3 text-4xl">ğŸ“Š</div>
                        <p class="text-gray-400 text-sm">è«‹åœ¨å·¦å´è¼¸å…¥ä»£ç¢¼ä¸¦åŸ·è¡Œå›æ¸¬</p>
                    </div>
                    <canvas id="mainChart" class="hidden"></canvas>
                </div>
            </div>

            <div class="bg-white rounded-2xl shadow-sm border border-gray-100">
                <div class="p-6 border-b border-gray-100">
                    <h3 class="font-bold text-gray-800 flex items-center gap-2"><svg class="w-5 h-5 text-gray-500"
                            fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z">
                            </path>
                        </svg>äº¤æ˜“è©³ç´°åˆ†æ</h3>
                </div>
                <div class="p-6">
                    <div class="flex flex-col xl:flex-row gap-8">
                        <div class="flex-1 overflow-x-auto">
                            <h4 class="text-xs font-bold text-gray-400 uppercase tracking-wider mb-4">æœˆåº¦å ±é…¬ç†±åŠ›åœ–</h4>
                            <table class="w-full text-sm text-center border-collapse">
                                <thead>
                                    <tr class="text-xs text-gray-400 border-b border-gray-100">
                                        <th class="p-2 font-medium">Year</th>
                                        <th class="p-2">Jan</th>
                                        <th class="p-2">Feb</th>
                                        <th class="p-2">Mar</th>
                                        <th class="p-2">Apr</th>
                                        <th class="p-2">May</th>
                                        <th class="p-2">Jun</th>
                                        <th class="p-2">Jul</th>
                                        <th class="p-2">Aug</th>
                                        <th class="p-2">Sep</th>
                                        <th class="p-2">Oct</th>
                                        <th class="p-2">Nov</th>
                                        <th class="p-2">Dec</th>
                                        <th class="p-2 font-bold text-gray-600">Total</th>
                                    </tr>
                                </thead>
                                <tbody id="heatmapBody" class="text-xs">
                                    <tr>
                                        <td colspan="14" class="p-8 text-gray-400 text-center">ç­‰å¾…æ•¸æ“šä¸­...</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                        <div class="w-full xl:w-72 flex-shrink-0 space-y-4">
                            <h4 class="text-xs font-bold text-gray-400 uppercase tracking-wider mb-4">é¢¨éšªæ•¸æ“š</h4>
                            <div class="bg-gray-50 rounded-xl p-6 text-center border border-gray-100">
                                <p class="text-xs text-gray-500 mb-2">å¹³å‡äº¤æ˜“ç›ˆè™§</p>
                                <p class="text-3xl font-bold tracking-tight text-gray-300" id="res_avg_pnl">--</p>
                                <span class="text-xs text-gray-400 mt-1 block">TWD / USD</span>
                            </div>
                            <div
                                class="bg-white rounded-xl p-4 border border-gray-200 flex justify-between items-center">
                                <span class="text-xs text-gray-500">æœ€å¤§é€£è™§æ¬¡æ•¸</span><span
                                    class="font-bold text-gray-700 text-lg" id="res_consec_loss">--</span></div>
                        </div>
                    </div>
                    <div class="border-t border-dashed border-gray-200 my-8"></div>
                    <div>
                        <h4 class="text-xs font-bold text-gray-400 uppercase tracking-wider mb-4">æ­·å²äº¤æ˜“ç´€éŒ„</h4>
                        <div class="overflow-hidden">
                            <div id="tradeListContainer"
                                class="space-y-0 divide-y divide-gray-100 max-h-[500px] overflow-y-auto custom-scrollbar pr-2">
                                <p class="text-sm text-gray-400 py-8 text-center">è«‹åŸ·è¡Œå›æ¸¬ä»¥æŸ¥çœ‹è©³ç´°ç´€éŒ„</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <footer class="text-center text-xs text-gray-400 py-6">&copy; SmartInvest Project.</footer>
        </div>
        <script src="/static/js/main.js"></script>
        <script>
            function resetParams() {
                if (confirm("ç¢ºå®šè¦é‡ç½®æ‰€æœ‰åƒæ•¸ç‚ºé è¨­å€¼å—ï¼Ÿ")) {
                    document.getElementById('ma_short').value = 10;
                    document.getElementById('ma_long').value = 60;
                    document.getElementById('rsi_period_entry').value = 14;
                    document.getElementById('rsi_buy_threshold').value = 70; // [ä¿®æ­£] é‡ç½®å€¼
                    document.getElementById('rsi_period_exit').value = 14;
                    document.getElementById('rsi_sell_threshold').value = 80; // [ä¿®æ­£] é‡ç½®å€¼
                    document.getElementById('sl_pct').value = 0;
                    document.getElementById('tp_pct').value = 0;
                    document.getElementById('cash').value = 100000;
                }
            }
        </script>
        {% endblock %}