{% extends "base.html" %}

{% block content %}

<!-- ä½ˆå±€å®¹å™¨ï¼šåœ¨ Desktop (lg) æ¨¡å¼ä¸‹å·¦å³ä¸¦æ’ï¼Œæ‰‹æ©Ÿæ¨¡å¼ä¸‹å‚ç›´æ’åˆ— -->
<div class="flex flex-col lg:flex-row w-full h-full">

    <!-- ========================== -->
    <!-- å·¦å´è¨­å®šå€ (Sidebar Module) -->
    <!-- ========================== -->
    <div class="w-full lg:w-80 bg-white border-r border-gray-200 flex-shrink-0 flex flex-col h-full z-10">

        <!-- æ¨™é¡Œå€ -->
        <div class="p-4 border-b border-gray-100 flex items-center justify-between bg-white sticky top-0 z-10">
            <h2 class="font-bold text-gray-700 flex items-center gap-2">
                <svg class="w-4 h-4 text-blue-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M12 6V4m0 2a2 2 0 100 4m0-4a2 2 0 110 4m-6 8a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4m6 6v10m6-2a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4">
                    </path>
                </svg>
                åƒæ•¸è¨­å®š
            </h2>
            <button onclick="resetParams()" class="text-xs text-blue-500 hover:text-blue-700">é‡ç½®</button>
        </div>

        <!-- æ»¾å‹•å…§å®¹å€ custom-scrollbar -->
        <div class="overflow-y-auto flex-1 p-4 custom-scrollbar space-y-6">

            <!-- 1. æ¨™çš„è¨­å®š -->
            <div class="space-y-3">
                <p class="text-xs font-bold text-gray-400 uppercase tracking-wider">æ¨™çš„èˆ‡è³‡é‡‘</p>
                <div>
                    <label class="block text-xs font-medium text-gray-600 mb-1">è‚¡ç¥¨ä»£ç¢¼</label>
                    <input type="text" id="ticker"
                        class="w-full bg-gray-50 border border-gray-200 rounded-lg p-2.5 text-sm uppercase focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none transition font-mono"
                        placeholder="2330, 006208, NVDA">
                    <p class="text-[10px] text-gray-400 mt-1 h-3" id="tickerHint"></p>
                </div>

                <div>
                    <label class="block text-xs font-medium text-gray-600 mb-1">åˆå§‹æœ¬é‡‘</label>
                    <div class="relative">
                        <span class="absolute left-3 top-2.5 text-gray-400 text-sm">$</span>
                        <input type="number" id="cash" value="100000"
                            class="w-full bg-gray-50 border border-gray-200 rounded-lg pl-6 p-2.5 text-sm">
                    </div>
                </div>

                <div class="grid grid-cols-2 gap-2">
                    <div>
                        <label class="block text-xs font-medium text-gray-600 mb-1">é–‹å§‹æ—¥æœŸ</label>
                        <input type="date" id="start_date"
                            class="w-full bg-gray-50 border border-gray-200 rounded-lg p-2 text-xs">
                    </div>
                    <div>
                        <label class="block text-xs font-medium text-gray-600 mb-1">çµæŸæ—¥æœŸ</label>
                        <input type="date" id="end_date"
                            class="w-full bg-gray-50 border border-gray-200 rounded-lg p-2 text-xs">
                    </div>
                </div>
            </div>

            <hr class="border-gray-100">

            <!-- 2. ç­–ç•¥è¨­å®š -->
            <div class="space-y-3">
                <p class="text-xs font-bold text-gray-400 uppercase tracking-wider">å‡ç·šèˆ‡æŒ‡æ¨™</p>
                <div class="grid grid-cols-2 gap-3">
                    <div>
                        <label class="block text-xs font-medium text-gray-600 mb-1">çŸ­å‡ç·š (MA Fast)</label>
                        <input type="number" id="ma_short" value="10"
                            class="w-full border border-gray-200 rounded-lg p-2 text-sm text-center focus:border-blue-500 outline-none">
                    </div>
                    <div>
                        <label class="block text-xs font-medium text-gray-600 mb-1">é•·å‡ç·š (MA Slow)</label>
                        <input type="number" id="ma_long" value="60"
                            class="w-full border border-gray-200 rounded-lg p-2 text-sm text-center focus:border-blue-500 outline-none">
                    </div>
                </div>

                <!-- RSI è¨­å®š -->
                <div class="bg-blue-50 p-3 rounded-lg border border-blue-100">
                    <div class="flex justify-between items-center mb-2">
                        <label class="text-xs font-bold text-blue-800">RSI æ¿¾ç¶²</label>
                        <span
                            class="text-[10px] text-blue-600 bg-white px-1.5 rounded border border-blue-200">é€²å ´é™åˆ¶</span>
                    </div>
                    <div class="grid grid-cols-2 gap-2">
                        <div>
                            <span class="text-[10px] text-gray-500">é€±æœŸ</span>
                            <input type="number" id="rsi_period" value="14"
                                class="w-full border border-gray-200 rounded p-1.5 text-sm text-center">
                        </div>
                        <div>
                            <span class="text-[10px] text-gray-500">ä¸Šé™</span>
                            <input type="number" id="rsi_overbought" value="70"
                                class="w-full border border-gray-200 rounded p-1.5 text-sm text-center font-bold text-blue-600">
                        </div>
                    </div>
                </div>
            </div>

            <hr class="border-gray-100">

            <!-- 3. é¢¨æ§è¨­å®š -->
            <div class="space-y-3">
                <p class="text-xs font-bold text-gray-400 uppercase tracking-wider">å‡ºå ´èˆ‡é¢¨æ§</p>
                <div class="grid grid-cols-2 gap-3">
                    <div>
                        <label class="block text-xs font-medium text-gray-600 mb-1">åœæ (%)</label>
                        <input type="number" id="sl_pct" value="0" step="0.5"
                            class="w-full border border-gray-200 rounded-lg p-2 text-sm text-red-600 font-bold bg-red-50 focus:bg-white transition">
                    </div>
                    <div>
                        <label class="block text-xs font-medium text-gray-600 mb-1">åœåˆ© (%)</label>
                        <input type="number" id="tp_pct" value="0" step="0.5"
                            class="w-full border border-gray-200 rounded-lg p-2 text-sm text-green-600 font-bold bg-green-50 focus:bg-white transition">
                    </div>
                </div>

                <!-- æ‰‹çºŒè²»æ‘ºç–Šé¸å–® (ç‚ºäº†çœç©ºé–“) -->
                <details class="group">
                    <summary
                        class="flex justify-between items-center font-medium cursor-pointer list-none text-xs text-gray-500 hover:text-gray-700">
                        <span>é€²éšï¼šäº¤æ˜“æ‰‹çºŒè²»</span>
                        <span class="transition group-open:rotate-180">
                            <svg fill="none" height="16" shape-rendering="geometricPrecision" stroke="currentColor"
                                stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" viewBox="0 0 24 24"
                                width="16">
                                <path d="M6 9l6 6 6-6"></path>
                            </svg>
                        </span>
                    </summary>
                    <div class="text-neutral-600 mt-2 grid grid-cols-2 gap-2 animate-fadeIn">
                        <div>
                            <label class="text-[10px]">è²·å…¥ (%)</label>
                            <input type="number" step="0.0001" id="buy_fee" value="0.1425"
                                class="w-full border rounded p-1 text-xs">
                        </div>
                        <div>
                            <label class="text-[10px]">è³£å‡º (%)</label>
                            <input type="number" step="0.0001" id="sell_fee" value="0.4425"
                                class="w-full border rounded p-1 text-xs">
                        </div>
                    </div>
                </details>
            </div>

            <!-- åº•éƒ¨ç•™ç™½ï¼Œé¿å…æœ€å¾Œä¸€å€‹å…ƒç´ è²¼åº• -->
            <div class="h-10"></div>
        </div>

        <!-- åº•éƒ¨å›ºå®šæŒ‰éˆ•å€ -->
        <div class="p-4 border-t border-gray-200 bg-gray-50 sticky bottom-0 z-10">
            <button type="button" id="runBtn" onclick="executeBacktest()"
                class="w-full bg-blue-600 hover:bg-blue-700 active:scale-95 text-white font-bold py-3 rounded-xl transition shadow-lg shadow-blue-500/30 flex justify-center items-center gap-2">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M14.752 11.168l-3.197-2.132A1 1 0 0010 9.87v4.263a1 1 0 001.555.832l3.197-2.132a1 1 0 000-1.664z">
                    </path>
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                </svg>
                é–‹å§‹å›æ¸¬
            </button>
        </div>
    </div>

    <!-- ========================== -->
    <!-- å³å´ä¸»è¦å…§å®¹å€ (Main Content) -->
    <!-- ========================== -->
    <div class="flex-1 bg-gray-100 h-full overflow-y-auto custom-scrollbar relative">

        <div class="max-w-6xl mx-auto p-4 lg:p-8 space-y-6">

            <!-- é ‚éƒ¨ç¸¾æ•ˆå¡ç‰‡å€ -->
            <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                <div class="bg-white p-5 rounded-2xl shadow-sm border border-gray-100 flex flex-col justify-between">
                    <p class="text-xs font-medium text-gray-400">å¹´åŒ–å ±é…¬ç‡ (CAGR)</p>
                    <p class="text-3xl font-bold text-gray-300 mt-1" id="res_ann_return">--%</p>
                </div>
                <div class="bg-white p-5 rounded-2xl shadow-sm border border-gray-100 flex flex-col justify-between">
                    <div class="flex justify-between items-start">
                        <p class="text-xs font-medium text-gray-400">ç¸½å ±é…¬ç‡</p>
                        <span class="text-[10px] bg-gray-100 text-gray-500 px-2 py-0.5 rounded-full">Buy&Hold: <span
                                id="res_bh_return">--</span></span>
                    </div>
                    <p class="text-3xl font-bold text-gray-300 mt-1" id="res_total_return">--%</p>
                </div>
                <div
                    class="bg-gradient-to-br from-gray-800 to-gray-900 text-white p-5 rounded-2xl shadow-lg shadow-gray-400/20 flex flex-col justify-between">
                    <p class="text-xs font-medium text-gray-400">æœ€çµ‚è³‡ç”¢ (Equity)</p>
                    <p class="text-3xl font-bold mt-1" id="res_final_equity">$ --</p>
                </div>
                <div class="bg-white p-5 rounded-2xl shadow-sm border border-gray-100 flex flex-col justify-between">
                    <p class="text-xs font-medium text-gray-400">å‹ç‡ / äº¤æ˜“æ¬¡æ•¸</p>
                    <div class="flex items-baseline gap-2 mt-1">
                        <p class="text-3xl font-bold text-gray-300" id="res_win_rate">--%</p>
                        <span class="text-sm text-gray-400">(<span id="res_trades">--</span>ç­†)</span>
                    </div>
                </div>
            </div>

            <!-- ä¸»åœ–è¡¨å€ -->
            <div class="bg-white p-6 rounded-2xl shadow-sm border border-gray-100">
                <div class="flex justify-between items-center mb-6">
                    <div>
                        <h3 class="font-bold text-gray-800 text-lg">è³‡ç”¢èµ°å‹¢åœ–</h3>
                        <p class="text-xs text-gray-500">æ¯”è¼ƒç­–ç•¥èˆ‡æŒæœ‰ç­–ç•¥çš„è³‡ç”¢è®ŠåŒ–</p>
                    </div>
                    <div class="flex gap-2">
                        <button type="button" onclick="resetZoom()"
                            class="px-3 py-1.5 text-xs font-medium text-gray-600 bg-gray-100 rounded hover:bg-gray-200 transition">
                            é‡ç½®ç¸®æ”¾
                        </button>
                        <button type="button" id="lockBtn"
                            class="px-3 py-1.5 text-xs font-medium text-blue-600 bg-blue-50 border border-blue-100 rounded hover:bg-blue-100 transition">
                            é–å®šæ›²ç·š
                        </button>
                    </div>
                </div>

                <div class="relative w-full h-[400px] flex items-center justify-center bg-gray-50 rounded-xl border border-dashed border-gray-200"
                    id="chartContainer">
                    <div class="text-center" id="chartPlaceholder">
                        <div class="mb-3 text-4xl">ğŸ“Š</div>
                        <p class="text-gray-400 text-sm">è«‹åœ¨å·¦å´è¼¸å…¥ä»£ç¢¼ä¸¦åŸ·è¡Œå›æ¸¬</p>
                    </div>
                    <canvas id="mainChart" class="hidden"></canvas>
                </div>
            </div>

            <!-- ä¸‹æ–¹è©³ç´°æ•¸æ“šå€ï¼šç†±åŠ›åœ– + å…¶ä»–çµ±è¨ˆ -->
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                <!-- ç†±åŠ›åœ– -->
                <div class="lg:col-span-2 bg-white p-6 rounded-2xl shadow-sm border border-gray-100">
                    <h3 class="font-bold text-gray-800 mb-4 flex items-center gap-2">
                        <svg class="w-4 h-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z">
                            </path>
                        </svg>
                        æœˆåº¦å ±é…¬ç†±åŠ›åœ–
                    </h3>
                    <div class="overflow-x-auto">
                        <table class="w-full text-sm text-center border-collapse">
                            <thead>
                                <tr class="text-xs text-gray-400 border-b border-gray-100">
                                    <th class="p-2 font-medium">Year</th>
                                    <th class="p-2 font-normal">Jan</th>
                                    <th class="p-2 font-normal">Feb</th>
                                    <th class="p-2 font-normal">Mar</th>
                                    <th class="p-2 font-normal">Apr</th>
                                    <th class="p-2 font-normal">May</th>
                                    <th class="p-2 font-normal">Jun</th>
                                    <th class="p-2 font-normal">Jul</th>
                                    <th class="p-2 font-normal">Aug</th>
                                    <th class="p-2 font-normal">Sep</th>
                                    <th class="p-2 font-normal">Oct</th>
                                    <th class="p-2 font-normal">Nov</th>
                                    <th class="p-2 font-normal">Dec</th>
                                    <th class="p-2 font-bold text-gray-600">Total</th>
                                </tr>
                            </thead>
                            <tbody id="heatmapBody" class="text-xs">
                                <tr>
                                    <td colspan="14" class="p-8 text-gray-400 text-center">ç­‰å¾…æ•¸æ“šä¸­...</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <div class="col-span-1 lg:col-span-3 bg-white p-6 rounded-2xl shadow-sm border border-gray-100 mt-6">
                    <h3 class="font-bold text-gray-800 mb-4 flex items-center gap-2 border-b pb-4">
                        <svg class="w-5 h-5 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 7h3m-3 4h3m-6-4h.01M9 16h.01">
                            </path>
                        </svg>
                        äº¤æ˜“ç´€éŒ„
                    </h3>

                    <div class="overflow-hidden">
                        <!-- äº¤æ˜“åˆ—è¡¨å®¹å™¨ -->
                        <div id="tradeListContainer" class="space-y-0 divide-y divide-gray-100">
                            <p class="text-sm text-gray-400 py-8 text-center">è«‹åŸ·è¡Œå›æ¸¬ä»¥æŸ¥çœ‹è©³ç´°ç´€éŒ„</p>
                        </div>
                    </div>
                </div>

                <!-- é¡å¤–è³‡è¨Šï¼šä¾‹å¦‚æœ€å¤§å›æ’¤ (é€™è£¡å¯ä»¥æœªä¾†æ“´å……) -->
                <div class="bg-white p-6 rounded-2xl shadow-sm border border-gray-100">
                    <h3 class="font-bold text-gray-800 mb-4">é¢¨éšªæŒ‡æ¨™</h3>
                    <div class="space-y-4">
                        <!-- 1. å¹³å‡äº¤æ˜“ç›ˆè™§å¡ç‰‡ (å°æ‡‰æ‚¨çš„æˆªåœ–) -->
                        <div
                            class="bg-white p-6 rounded-2xl shadow-sm border border-gray-100 flex flex-col items-center justify-center text-center h-[180px]">
                            <p class="text-sm font-medium text-gray-500 mb-2">å¹³å‡äº¤æ˜“ç›ˆè™§</p>

                            <!-- æ•¸å€¼é¡¯ç¤ºå€ -->
                            <p class="text-4xl font-bold tracking-tight" id="res_avg_pnl">--</p>
                            <span class="text-sm text-gray-400 mt-2">å…ƒ</span>
                        </div>

                        <!-- 2. å…¶ä»–é¢¨éšªæ•¸æ“š (ä¿ç•™æœ€å¤§é€£è™§ï¼Œé€™å¾ˆé‡è¦) -->
                        <div class="bg-white p-5 rounded-2xl shadow-sm border border-gray-100">
                            <div class="flex justify-between items-center">
                                <span class="text-xs text-gray-500 font-medium">æœ€å¤§é€£è™§æ¬¡æ•¸</span>
                                <span class="text-lg font-bold text-gray-700" id="res_consec_loss">--</span>
                            </div>
                        </div>
                    </div>

                    <!-- é å°¾ -->
                    <footer class="text-center text-xs text-gray-400 py-6">
                        &copy; SmartInvest Project.
                    </footer>

                </div>
            </div>
        </div>

        <script src="/static/js/main.js"></script>
        <script>
            // ç°¡å–®çš„é‡ç½®åŠŸèƒ½
            function resetParams() {
                if (confirm("ç¢ºå®šè¦é‡ç½®æ‰€æœ‰åƒæ•¸ç‚ºé è¨­å€¼å—ï¼Ÿ")) {
                    document.getElementById('ma_short').value = 10;
                    document.getElementById('ma_long').value = 60;
                    document.getElementById('rsi_period').value = 14;
                    document.getElementById('rsi_overbought').value = 70;
                    document.getElementById('sl_pct').value = 0;
                    document.getElementById('tp_pct').value = 0;
                    document.getElementById('cash').value = 100000;
                }
            }
        </script>
        {% endblock %}