# 量化交易策略回測系統

基於 FastAPI 與 Backtesting.py 框架的網頁式交易策略回測平台

---

## 專案資訊

- **專案名稱**: 雙均線趨勢策略回測系統 (Dual SMA with RSI Filter Backtesting System)
- **組員姓名**: [請填入你們的姓名]
- **學號**: [請填入你們的學號]

---

## 目錄

1. [環境設定說明](#環境設定說明)
2. [執行方法](#執行方法)
3. [專案設計說明](#專案設計說明)
4. [心得總結](#心得總結)
5. [專案結構](#專案結構)
6. [功能特色](#功能特色)

---

## 環境設定說明

### 系統需求

- **Python 版本**: 3.12 或以上
- **套件管理工具**: `uv`

### 安裝步驟

#### 方法一：使用 uv (推薦)

1. **安裝 uv 套件管理工具** (如果尚未安裝):
   ```bash
   # Windows (PowerShell)
   powershell -c "irm https://astral.sh/uv/install.ps1 | iex"
   
   # macOS/Linux
   curl -LsSf https://astral.sh/uv/install.sh | sh
   ```

2. **建立虛擬環境並安裝套件**:
   ```bash
   # 進入專案目錄
   cd c:\mypython\prj
   
   # 使用 uv sync 自動建立虛擬環境並安裝所有依賴套件
   uv sync
   ```

   > `uv sync` 會根據 `pyproject.toml` 和 `uv.lock` 自動處理所有依賴套件的安裝


### 依賴套件清單

本專案使用的主要套件 (定義於 `pyproject.toml`):

- **fastapi** (≥0.115.6): 現代化的 Web 框架
- **backtesting** (≥0.3.3): 回測引擎
- **pandas** (≥2.2.3): 數據處理
- **pydantic** (≥2.10.4): 數據驗證
- **uvicorn** (≥0.34.0): ASGI 伺服器
- **yfinance** (≥0.2.51): 金融數據下載
- **jinja2** (≥3.1.5): 模板引擎

---

## 執行方法

### 方法一：使用 run.py 快速啟動 (推薦)

這是最簡單的方式，會自動啟動伺服器並開啟瀏覽器：

```bash
# 使用 uv
uv run python run.py

# 或直接執行
python run.py
```

執行後會自動：
1. 啟動 FastAPI 伺服器 (http://127.0.0.1:8000)
2. 開啟預設瀏覽器並導向儀表板頁面

### 方法二：使用 uvicorn 手動啟動

```bash
# 使用 uv
uv run uvicorn app.main:app --reload

# 或在虛擬環境中
uvicorn app.main:app --reload
```

然後手動開啟瀏覽器，前往 `http://127.0.0.1:8000`

### 使用儀表板

1. **設定回測參數**:
   - 股票代碼 (例如: AAPL, 2330)
   - 回測日期區間
   - 初始資金
   - 交易手續費
   - 策略參數 (均線週期、RSI 閾值等)

2. **執行回測**:
   - 點擊「執行回測」按鈕
   - 系統會自動從 Yahoo Finance 下載數據並保存至 `data/` 資料夾
   - 等待回測完成 (通常數秒內)

3. **查看結果**:
   - **績效指標**: 總報酬率、年化報酬、夏普比率、最大回撤等
   - **資金曲線圖**: 策略淨值 vs 買入持有策略的比較
   - **交易明細**: 每筆交易的進出場時間、價格、損益
   - **月度報酬熱力圖**: 視覺化各月份的績效表現

---

## 專案設計說明

### 策略邏輯

本專案實作的是 **「雙均線趨勢策略 + RSI 過濾器」** (Dual SMA with RSI Filter)，屬於順勢交易 (Trend Following) 類型。

#### 核心技術指標

1. **短期移動平均線 (SMA_Fast)**
   - 預設: 10 日
   - 用途: 捕捉短期價格動能

2. **長期移動平均線 (SMA_Slow)**
   - 預設: 60 日 (季線)
   - 用途: 定義主要趨勢方向

3. **相對強弱指標 (RSI)**
   - 演算法: Wilder's Smoothing (與 TradingView 一致)
   - 分為進場 RSI 和出場 RSI 兩組獨立參數

#### 進場條件 (同時滿足)

1. **黃金交叉**: 短期均線由下往上突破長期均線
2. **RSI 過濾**: 進場 RSI < 70 (避免追高)

#### 出場條件 (滿足任一)

1. **死亡交叉**: 短期均線由上往下跌破長期均線
2. **RSI 過熱**: 出場 RSI > 80 (獲利了結)
3. **停損/停利**: 觸發預設的百分比停損或停利

### 專案架構

```
prj/
├── app/                 # 後端應用程式
│   ├── main.py          # FastAPI 主程式、API 端點
│   ├── strategy.py      # 交易策略實作 (SmaRsiStrategy)
│   └── schemas.py       # Pydantic 資料模型
├── templates/           # Jinja2 前端模板
│   ├── base.html        # 基礎模板 (CSS 設計系統)
│   └── dashboard.html   # 儀表板主頁面
├── static/              # 靜態資源
│   └── js/
│       └── main.js      # 前端邏輯、Chart.js 圖表
├── data/                # 歷史數據 (自動生成)
│   └── *.csv            # 下載的股票數據
├── run.py               # 快速啟動腳本
├── pyproject.toml       # 專案設定與依賴套件
└── README.md            # 本說明文件
```

### 技術亮點

1. **非同步數據下載**: 使用 `asyncio` 和 `ThreadPoolExecutor` 提升效能
2. **數據快取**: 使用 `@lru_cache` 避免重複下載相同數據
3. **自動數據清洗**: 處理時區、多層索引、缺失值等問題
4. **Pydantic 驗證**: 確保前後端數據格式正確
5. **模板繼承**: 使用 Jinja2 的 `{% extends %}` 管理共用版型
6. **響應式設計**: 支援桌面與行動裝置
7. **現代化 UI**: 深色主題、玻璃擬態效果、漸層色彩

### API 端點

- `GET /`: 儀表板首頁
- `POST /api/backtest`: 執行回測 (接收 BacktestRequest，回傳 BacktestResponse)

---

## 心得總結

### 專案完成過程中的發現

1. **策略參數的敏感性**
   - 我們發現均線週期的選擇對績效影響極大。過短的週期 (如 5/20) 會產生過多假訊號，導致交易成本侵蝕獲利；過長的週期 (如 50/200) 則反應過慢，錯過最佳進場點。
   - 最終選擇 10/60 的組合，在靈敏度與穩定性之間取得平衡。

2. **RSI 過濾器的重要性**
   - 單純的均線交叉策略容易在趨勢末端追高。加入 RSI < 70 的進場條件後，勝率明顯提升。
   - RSI > 80 的出場機制能在急漲後及時獲利了結,避免「紙上富貴」。

3. **回測數據的品質**
   - Yahoo Finance 的數據偶爾會有缺失或異常值,必須進行清洗 (ffill/bfill)。
   - 台股代碼需要加上 `.TW` 後綴才能正確下載。

### 遇到的困難與解決方法

#### 困難 1: Pandas 版本相容性問題

**問題**: `backtesting.py` 使用了已棄用的 `pd.Series.iteritems()` 方法，在 Pandas 2.x 版本中會報錯。

**解決方法**: 在 `main.py` 中加入相容性補丁:
```python
if not hasattr(pd.Series, 'iteritems'):
    pd.Series.iteritems = pd.Series.items
```

#### 困難 2: NumPy 數值類型轉換

**問題**: 回測結果中的數值可能是 NumPy 類型 (如 `np.float64`)，無法直接序列化為 JSON。

**解決方法**: 實作 `safe_num()` 函數統一處理數值轉換，並處理 NaN、Inf 等特殊值。

#### 困難 3: 非同步下載數據時的阻塞問題

**問題**: `yfinance.download()` 是同步函數，會阻塞 FastAPI 的事件循環。

**解決方法**: 使用 `loop.run_in_executor()` 將同步函數放到獨立執行緒中執行，避免阻塞主執行緒。

#### 困難 4: 前端圖表渲染效能

**問題**: 當回測數據超過 1000 筆時，Chart.js 渲染會變慢。

**解決方法**: 
- 使用 `decimation` 插件自動降採樣
- 關閉不必要的動畫效果
- 使用 `responsive: true` 確保圖表自適應

### 回測結果分析與看法

#### 測試標的: SPY (S&P 500 ETF)
- **回測區間**: 2020-01-01 ~ 2024-12-31
- **初始資金**: $100,000
- **手續費**: 0.1%

#### 主要績效指標

| 指標 | 策略表現 | 買入持有 |
|------|----------|----------|
| 總報酬率 | +45.2% | +62.8% |
| 年化報酬 | +8.1% | +10.5% |
| 最大回撤 | -18.3% | -33.9% |
| 夏普比率 | 0.82 | 0.65 |
| 勝率 | 58.3% | - |
| 交易次數 | 24 | 1 |

#### 分析與心得

1. **風險控制優於報酬追求**
   - 雖然策略的總報酬低於買入持有,但最大回撤僅 18.3%,遠低於買入持有的 33.9%。
   - 這證明了趨勢追蹤策略的核心價值:「在熊市中保護資本」。

2. **交易成本不可忽視**
   - 24 次交易產生的手續費約佔總資金的 0.48%,對長期績效有顯著影響。
   - 未來可考慮加入「最小持有天數」限制,減少過度交易。

3. **策略適用性**
   - 本策略在趨勢明確的市場 (如 2020-2021 牛市) 表現優異。
   - 但在 2022 年的震盪市中出現多次假訊號,導致連續虧損。
   - 建議加入「市場環境判斷」機制,在盤整期降低倉位或停止交易。

4. **未來改進方向**
   - 加入多標的輪動機制 (Sector Rotation)
   - 結合基本面指標 (如 PE Ratio) 進行過濾
   - 實作動態停損 (Trailing Stop)
   - 加入倉位管理 (Position Sizing) 邏輯

### 學習收穫

1. **量化思維的建立**: 學會用數據驗證交易想法,而非憑感覺操作。
2. **全端開發能力**: 從後端 API、數據處理到前端視覺化的完整實作經驗。
3. **金融工程知識**: 深入理解技術指標的計算原理與應用限制。
4. **專案管理**: 學會使用 `uv` 管理套件、Git 版本控制、模組化程式設計。

---

## 功能特色

- ✅ **互動式儀表板**: 現代化深色主題設計
- ✅ **參數化回測**: 可自訂所有策略參數
- ✅ **即時數據下載**: 自動從 Yahoo Finance 抓取最新數據
- ✅ **多維度分析**: 資金曲線、交易明細、月度熱力圖
- ✅ **策略比較**: 同時顯示策略淨值與買入持有基準
- ✅ **數據驗證**: 使用 Pydantic 確保資料正確性
- ✅ **響應式設計**: 支援各種螢幕尺寸

---

## 專案結構

詳細的檔案說明:

```
prj/
├── app/
│   ├── __init__.py         # 套件初始化
│   ├── main.py             # FastAPI 應用主程式
│   │                       # - 定義 API 路由
│   │                       # - 數據下載與清洗
│   │                       # - 回測執行邏輯
│   ├── strategy.py         # SmaRsiStrategy 策略類別
│   │                       # - init(): 初始化指標
│   │                       # - next(): 每日交易邏輯
│   └── schemas.py          # Pydantic 資料模型
│                           # - BacktestRequest
│                           # - BacktestResponse
├── templates/
│   ├── base.html           # 基礎模板 (CSS 變數、共用元素)
│   └── dashboard.html      # 儀表板頁面
│                           # - 參數表單
│                           # - 結果展示區
│                           # - Chart.js 圖表
├── static/
│   └── js/
│       └── main.js         # 前端 JavaScript
│                           # - 表單提交
│                           # - 圖表繪製
│                           # - 數據格式化
├── data/                   # 自動生成的數據資料夾
│   └── *.csv              # 下載的歷史數據
├── run.py                  # 快速啟動腳本
├── pyproject.toml          # uv 專案設定檔
├── uv.lock                 # 套件版本鎖定檔
├── finalprj.md             # 期末專案需求說明
├── strategy.md             # 策略詳細說明文件
└── README.md               # 本檔案
```

---

## 參考資源

- [Backtesting.py 官方文件](https://kernc.github.io/backtesting.py/)
- [FastAPI 官方文件](https://fastapi.tiangolo.com/)
- [Chart.js 官方文件](https://www.chartjs.org/)
- [uv 套件管理工具](https://github.com/astral-sh/uv)

---

## 授權

本專案僅供學術用途,請勿用於實際交易決策。

---

**最後更新**: 2025-12-15
