# 量化交易策略回測系統

基於 FastAPI 與 Backtesting.py 的網頁式交易策略回測平台，支援多種技術指標與彈性策略組合。

---

## 專案資訊

- **專案名稱**: Universal Trading Strategy Backtesting System 多策略回測系統
- **Python 版本**: 3.12+
- **組員姓名及學號**: [李佳霓C111126125、黃荷婷C111126148、鄭孟栩C111126143]

---

## 目錄

1. [環境設定](#-環境設定)
2. [執行方法](#-執行方法)
3. [專案架構](#-專案架構)
4. [策略系統](#-策略系統)
5. [系統功能總覽](#-系統功能總覽)
6. [技術細節](#-技術細節)
7. [心得總結](#-心得總結)


---

## 環境設定說明

### 系統需求

- **Python**: 3.12 或以上
- **套件管理**: `uv`
- **作業系統**: Windows / macOS / Linux

### 安裝 uv 套件管理工具

```bash
# Windows (PowerShell)
powershell -c "irm https://astral.sh/uv/install.ps1 | iex"

# macOS / Linux
curl -LsSf https://astral.sh/uv/install.sh | sh
```

### 安裝專案依賴

```bash
# 使用 uv
uv sync
```

### 核心依賴套件

| 套件 | 版本 | 用途 |
|------|------|------|
| **fastapi** | ≥0.115.6 | Web 框架 |
| **backtesting** | ≥0.3.3 | 回測引擎 |
| **pandas** | ≥2.2.3 | 數據處理 |
| **pydantic** | ≥2.10.4 | 資料驗證 |
| **uvicorn** | ≥0.34.0 | ASGI 伺服器 |
| **yfinance** | ≥0.2.51 | 金融數據下載 |
| **jinja2** | ≥3.1.5 | 模板引擎 |

---

## 執行方法

### 方法一：使用 run.py (推薦)

最簡單的啟動方式，會自動開啟瀏覽器：

```bash
# 使用 uv
uv run python run.py

# 或直接執行
python run.py
```

執行後會自動：
1. 啟動 FastAPI 伺服器 (http://127.0.0.1:8000)
2. 開啟預設瀏覽器並導向儀表板頁面

### 方法二：使用 uvicorn 手動啟動

```bash
# 使用 uv
uv run uvicorn app.main:app --reload

# 或在虛擬環境中
uvicorn app.main:app --reload
```

然後手動開啟瀏覽器，前往 `http://127.0.0.1:8000`

### 停止伺服器

在終端機按 `Ctrl + C` 即可停止伺服器。

---

## 專案架構

### 目錄結構

```
prj/
├── app/                      後端應用程式
│   ├── __init__.py           套件初始化
│   ├── main.py               FastAPI 主程式
│   │                          - API 路由定義
│   │                          - 數據下載與清洗
│   │                          - 回測執行邏輯
│   │                          - 績效指標計算
│   ├── strategy.py           通用策略系統
│   │                          - UniversalStrategy 類別
│   │                          - 技術指標函數庫 (SMA, RSI, MACD, KD, BBANDS, WILLR, Donchian)
│   │                          - 彈性訊號組合邏輯
│   └── schemas.py            Pydantic 資料模型
│                              - BacktestRequest (請求參數)
│                              - BacktestResponse (回測結果)
├── templates/                Jinja2 前端模板
│   ├── base.html             基礎模板 (CSS 設計系統)
│   └── dashboard.html        儀表板主頁面
│                              - 模式切換
│                              - 參數表單
│                              - 結果展示區
│                              - Chart.js 圖表
├── static/                   靜態資源
│   └── js/
│       └── main.js           前端邏輯
│                              - 表單提交與驗證
│                              - 圖表繪製 (資金曲線、熱力圖、回撤風險圖、損益分佈圖)
│                              - 數據格式化
├── data/                     歷史數據 (自動生成)
│   └── *.csv                 從 Yahoo Finance 下載的股票數據
├── run.py                    快速啟動腳本
├── pyproject.toml            專案設定檔
├── uv.lock                   套件版本鎖定檔
├── finalprj.md               期末專案需求說明
├── strategy.md               策略詳細說明文件
└── README.md                 說明文件
```

---

## 策略系統

### 三大模式設計

本專案採用 **UniversalStrategy** 通用策略架構，支援三種使用模式，滿足不同投資需求：

#### 1. 預設模式
**適合對象**: 快速測試、初學者

**預設策略**: 雙均線趨勢策略 + RSI 動能過濾

**進場條件** (AND 邏輯，需全部成立):
1. **黃金交叉**: 短期均線 (預設 10 日) 突破長期均線 (預設 60 日)
2. **RSI 過濾**: 進場 RSI < 70 (安全區間進場，避免追高)

**出場條件** (OR 邏輯，任一成立即出場):
1. **死亡交叉**: 短期均線跌破長期均線
2. **RSI 過熱**: 出場 RSI > 80 (情緒過熱，獲利了結)
3. **停損/停利**: 觸發預設的百分比停損或停利
4. **追蹤停損**: 啟動移動停損保護獲利

**可調參數**:
- 短/長期均線週期
- 進場/出場 RSI 週期與閾值
- 停損/停利/追蹤停損百分比

#### 2. 定期定額模式

**適合對象**: 存股族、長期投資者

**核心特色**: 真實模擬定期定額投資的現金流與成本。

**運作機制**:
- **定期入金**: 每月指定日期 (如 6 號) 自動轉入固定金額。
- **費用扣除**: 每次入金/交易時自動扣除設定的手續費 (真實反映存股成本)。
- **自動買進**: 扣費後將剩餘資金以當日收盤價盡量買入。
- **餘額累積**: 不足買一股的零股資金保留在帳戶，與下月資金合併使用。

#### 3. 自定義模式

**適合對象**: 進階使用者、策略研究

**特色**: 高度彈性的策略組裝工廠，不寫程式也能測試複雜策略。

**運作邏輯**:
- 支援多種訊號源並聯 (OR Logic)。
- 使用者可自由添加多個進場/出場條件，只要滿足其中之一即觸發訊號。

**支援技術指標**:
- **SMA**: 簡單移動平均線
```python
SMA(values, n)
```
- **RSI**: 相對強弱指標
```python
RSI(values, n=14)
```
- **MACD**: 指數平滑異同移動平均線
```python
MACD(values, fast=12, slow=26, signal=9)
```
- **KD**: 隨機指標
```python
KD(high, low, close, n=9)
```
- **BBANDS**: 布林通道
```python
BBANDS(values, n=20, std=2)
```
- **WILLR**: 威廉指標
```python
WILLR(high, low, close, n=14)
```
- **Donchian**: 海龜通道 (Donchian Channel)
```python
donchian_channel(high, low, close, n=20)
```

---

## 系統功能總覽

本系統整合了策略開發、數據抓取與績效分析，提供一站式的量化交易研究環境：

1.  **多模式回測引擎**:
    *   提供 **預設模式**、**定期定額模式** 與 **自定義模式** 三種模式，各種程度的使用者都能上手。
2.  **自動化數據抓取**:
    *   只需輸入股票代碼 (如 AAPL, 2330.TW)，系統自動從 Yahoo Finance 下載最新歷史數據，無需手動整理 CSV。
3.  **視覺化圖表**:
    *   **資金曲線圖**: 清楚比較「策略績效」與「買入持有」的差異。
    *   **月度熱力圖**: 用顏色深淺直觀呈現每個月的獲利狀況，一眼看出策略在淡旺季的表現。
    *   **回撤風險圖**: 呈現資產從高點回落的幅度 (Underwater Plot)，幫助了解策略面臨的最大壓力和風險。
    *   **損益分佈圖**: 統計每筆交易的盈虧分佈，快速掌握策略是靠「高勝率」還是「大賺小賠」獲利。
    *   **績效指標區**
        *   **總報酬率 (Total Return)**: 策略在回測期間的總獲利百分比。
        *   **年化報酬率 (CAGR)**: 將總報酬換算成每年的平均複利報酬，方便與銀行定存或其他商品比較。
        *   **買入持有報酬 (Buy & Hold Return)**: 若「第一天買進後就不動」的獲利表現，用來當作評估策略好壞的基準 (Benchmark)。
        *   **最大回撤 (Max Drawdown)**: 資產從最高點回落的最大幅度。數值越小代表風險越低，是評估「抗跌能力」的關鍵指標。
        *   **夏普比率 (Sharpe Ratio)**: 衡量「每承擔一單位風險能獲得多少報酬」。大於 1 代表表現優異，小於 0 代表不如定存。
        *   **獲利因子 (Profit Factor)**: 總獲利金額除以總虧損金額。大於 1.5 通常被視為一個健康的策略。
        *   **勝率 (Win Rate)**: 獲利交易筆數佔總交易筆數的比例。需注意「高勝率不代表一定賺錢」(可能小賺大賠)。
4.  **詳細交易紀錄**:
    *   列出每一筆進出場的時間、價格、損益，方便逐筆檢討策略邏輯。

---

## 心得總結

### 1. 從「憑感覺」到「憑數據」
在製作這個專案之前，我們看股票常常是看新聞或憑直覺。透過這個回測系統，我們第一次親眼看到許多「聽起來很厲害」的策略，在實際回測中其實是虧錢的。這讓我們學會了用客觀的數據來驗證想法，而不是盲目相信傳言。

### 2. 程式技術的整合應用
這門課程讓我們把 Python 基礎、網頁開發 (HTML/CSS) 和資料分析 (Pandas) 全部串聯起來。最大的挑戰在於「整合」——例如怎麼把 Python 算出來的 Numpy 格式陣列，轉換成 JavaScript 圖表套件看得懂的 JSON 格式。解決這些問題的過程，比單純寫程式更有成就感。

### 3. 專案管理的體驗
我們學會了使用 Git 進行版本控制，以及如何撰寫 README 文件來讓別人看懂我們的專案。一個好的軟體不只要功能強大，介面 (UI/UX) 的友善程度更是決定使用者體驗的關鍵。

### 4. 未來展望
目前的系統雖然只能回測單一股票，但未來希望能加入「投資組合」的功能，讓我們能測試同時持有台積電、蘋果和債券的整體績效。此外，如果能加入「股息再投入」的計算，對於存股族的模擬會更加準確。




---


### 遇到的困難與解決方法

#### 困難 1: 策略邏輯的程式化轉譯

**問題**: 心中想的策略 (如「黃金交叉」) 很簡單，但要寫成精確的程式碼時發現很多細節沒考慮到。例如：是「今天收盤剛好突破」還是「昨天還在下面，今天在上面」？

**解決方法**:
學習使用 `backtesting.py` 的 `crossover()` 函數，它能精確判斷兩條線「交叉」的瞬間，而不是單純比較數值大小。

**學習**: 程式語言需要非常嚴謹的邏輯定義，不能有模糊空間。

#### 困難 2: 回測與實際的落差

**問題**: 一開始回測怎麼測都賺錢，後來發現是因為沒有計算「手續費」。

**解決方法**:
在回測設定中加入 `commission=.001425` (台股手續費) 來模擬真實交易成本。


#### 困難 3: 選擇適合的參數

**問題**: 均線到底要用 5日、10日還是 20日？參數組合有無限多種，不知道怎麼選。

**解決方法**:
先用最常見的 10/60 (月線/季線) 當基準，再手動微調觀察變化。


---

### 回測結果分析與看法

#### 測試標的: AAPL (Apple Inc.)

**回測設定**:
- 回測區間: 2020-01-01 ~ 2024-12-31 (5 年)
- 初始資金: $100,000
- 手續費: 0.1%
- 策略: 雙均線 (10/60) + RSI 過濾 (70/80)

#### 主要績效指標

| 指標 | 策略表現 | 買入持有 | 差異 |
|------|----------|----------|------|
| 總報酬率 | +86.65% | +319.02% | -232.37% |
| 年化報酬 | +13.33% | +33.15% | -19.82% |
| 最大回撤 | -23.67% | > -30% | **風險較低** |
| 夏普比率 | 0.70 | - | - |
| 勝率 | 46.67% | - | - |
| 交易次數 | 15 | 1 | - |

#### 深度分析

##### 1. 強勢股的策略侷限性

**觀察**: 策略報酬遠低於買入持有 (86.7% vs 319.0%)。

**原因**: 
- **趨勢追蹤的延遲**: AAPL 這種長期強勢上漲的股票，大部分時間都在上漲。均線策略需要「確認」趨勢才會進場，導致錯過起漲段。
- **過早出場**: RSI > 80 的獲利了結機制，雖然避開了回調，但也導致在主升段中「賣太早」，錯過了後續的大段漲幅。
- **盤整期損失**: 2022 年或區間震盪時，均線反覆交叉產生了多筆小額虧損 (勝率不到 50%)。

**結論**: 對於長期趨勢向上且波動穩定的權值股 (如 AAPL)，簡單的 **「買入持有」** 或 **「定期定額」** 往往優於頻繁進出的波段策略。

##### 2. 風險控制的價值

**觀察**: 策略的最大回撤為 -23.67%，優於買入持有的表現 (AAPL 在 2022 年曾回檔超過 30%)。

**意義**: 雖然犧牲了大量潛在報酬，但策略確實提供了下檔保護。對於無法承受 30% 以上資產縮水的投資人，這種策略提供了心理上的安全感。

##### 3. 交易頻率過低

**觀察**: 5 年僅交易 15 次，平均每年僅 3 次。

**影響**: 
- 樣本數過少，統計顯著性不足。
- 資金閒置時間過長，未能充分利用複利效應。

**改進建議**: 可以考慮縮短均線週期 (如 5/20) 或調降 RSI 進場門檻，以增加交易機會，捕捉中短線波動。





