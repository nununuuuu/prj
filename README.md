# 量化交易策略回測系統

基於 FastAPI 與 Backtesting.py 的網頁式交易策略回測平台，支援多種技術指標與彈性策略組合。

---

## 專案資訊

- **專案名稱**: Universal Trading Strategy Backtesting System 多策略回測系統
- **Python 版本**: 3.12+
<!-- - **組員姓名**: [請填入你們的姓名]
- **學號**: [請填入你們的學號] -->

---

## 目錄

1. [快速開始](#-快速開始)
2. [環境設定](#-環境設定)
3. [執行方法](#-執行方法)
4. [專案架構](#-專案架構)
5. [策略系統](#-策略系統)
6. [功能特色](#-功能特色)
7. [使用指南](#-使用指南)
8. [心得總結](#-心得總結)
9. [參考資源](#-參考資源)

---

## 快速開始

### 最快啟動方式

```bash
# 1. 進入專案目錄
# 2. 安裝依賴 (首次執行)
uv sync

# 3. 啟動應用程式
uv run python run.py
```

執行後會自動開啟瀏覽器，前往 `http://127.0.0.1:8000`

---

## 環境設定說明

### 系統需求

- **Python**: 3.12 或以上
- **套件管理**: `uv`
- **作業系統**: Windows / macOS / Linux

### 安裝 uv 套件管理工具

```bash
# Windows (PowerShell)
powershell -c "irm https://astral.sh/uv/install.ps1 | iex"

# macOS / Linux
curl -LsSf https://astral.sh/uv/install.sh | sh
```

### 安裝專案依賴

```bash
# 使用 uv
uv sync
```

### 核心依賴套件

| 套件 | 版本 | 用途 |
|------|------|------|
| **fastapi** | ≥0.115.6 | Web 框架 |
| **backtesting** | ≥0.3.3 | 回測引擎 |
| **pandas** | ≥2.2.3 | 數據處理 |
| **pydantic** | ≥2.10.4 | 資料驗證 |
| **uvicorn** | ≥0.34.0 | ASGI 伺服器 |
| **yfinance** | ≥0.2.51 | 金融數據下載 |
| **jinja2** | ≥3.1.5 | 模板引擎 |

---

## 執行方法

### 方法一：使用 run.py (推薦)

最簡單的啟動方式，會自動開啟瀏覽器：

```bash
# 使用 uv
uv run python run.py

# 或直接執行
python run.py
```

執行後會自動：
1. 啟動 FastAPI 伺服器 (http://127.0.0.1:8000)
2. 開啟預設瀏覽器並導向儀表板頁面

### 方法二：使用 uvicorn 手動啟動

```bash
# 使用 uv
uv run uvicorn app.main:app --reload

# 或在虛擬環境中
uvicorn app.main:app --reload
```

然後手動開啟瀏覽器，前往 `http://127.0.0.1:8000`

### 停止伺服器

在終端機按 `Ctrl + C` 即可停止伺服器。

---

## 專案架構

### 目錄結構

```
prj/
├── app/                      # 後端應用程式
│   ├── __init__.py           # 套件初始化
│   ├── main.py               # FastAPI 主程式
│   ├── strategy.py           # 通用策略系統
│   └── schemas.py            # Pydantic 資料模型
├── templates/                # Jinja2 前端模板
│   ├── base.html             # 基礎模板 (CSS 設計系統)
│   └── dashboard.html        # 儀表板主頁面
├── static/                   # 靜態資源
│   └── js/
│       └── main.js           # 前端邏輯
├── data/                     # 歷史數據 (自動生成)
│   └── *.csv                 # 從 Yahoo Finance 下載的股票數據
├── run.py                    # 快速啟動腳本
├── pyproject.toml            # 專案設定檔
├── uv.lock                   # 套件版本鎖定檔
├── finalprj.md               # 期末專案需求說明
├── strategy.md               # 策略詳細說明文件
└── README.md                 # 本說明文件
```

---

## 策略系統

### 雙模式設計

本專案採用 **UniversalStrategy** 通用策略架構，支援兩種使用模式：

#### 預設模式 (Basic Mode)

**適合對象**: 快速測試

**預設策略**: 雙均線 + RSI 過濾器

**進場條件** (AND 邏輯，全部成立才買進):
1. **黃金交叉**: 短期均線 (預設 10 日) 突破長期均線 (預設 60 日)
2. **RSI 過濾**: 進場 RSI < 70 (避免追高)

**出場條件** (OR 邏輯，任一成立就賣出):
1. **死亡交叉**: 短期均線跌破長期均線
2. **RSI 過熱**: 出場 RSI > 80 (獲利了結)
3. **停損/停利**: 觸發百分比停損或停利

**可調參數**:
- 短期均線週期 (n1)
- 長期均線週期 (n2)
- 進場 RSI 週期與閾值
- 出場 RSI 週期與閾值
- 停損/停利/追蹤停損百分比

#### 自定義模式 (Advanced Mode)

**適合對象**: 進階使用者、策略研究

**特色**: 完全自訂進出場條件

**支援指標**:
- **SMA**: 簡單移動平均線
- **RSI**: 相對強弱指標 (Wilder's Smoothing)
- **MACD**: 指數平滑異同移動平均線
- **KD**: 隨機指標
- **BBANDS**: 布林通道
- **WILLR**: 威廉指標
- **Donchian**: 海龜通道 (Donchian Channel)


### 技術指標說明

#### 1. SMA (Simple Moving Average)
- **用途**: 平滑價格波動，判斷趨勢方向
- **常用週期**: 5, 10, 20, 60, 120, 240 日

#### 2. RSI (Relative Strength Index)
- **演算法**: Wilder's Smoothing (與 TradingView 一致)
- **範圍**: 0-100
- **超買**: > 70
- **超賣**: < 30

#### 3. MACD (Moving Average Convergence Divergence)
- **回傳**: (DIF, DEM) 快線與訊號線
- **黃金交叉**: DIF 由下往上突破 DEM
- **死亡交叉**: DIF 由上往下跌破 DEM

#### 4. KD (Stochastic Oscillator)
- **回傳**: (K, D) 快線與慢線
- **範圍**: 0-100
- **超買**: > 80
- **超賣**: < 20

#### 5. BBANDS (Bollinger Bands)
- **回傳**: (上軌, 下軌)
- **用途**: 判斷價格波動區間與突破訊號

#### 6. WILLR (Williams %R)
- **範圍**: -100 到 0
- **超買**: > -20
- **超賣**: < -80

#### 7. DONCHIAN (Donchian Channel)
- **用途**: 海龜法則，判斷 N 日區間突破

---

## 功能特色

### 核心功能

- **雙模式策略系統**: 基礎模式 + 進階模式
- **7 種技術指標**: SMA, RSI, MACD, KD, BBANDS, WILLR, Donchian (Turtle)
- **多功能停損停利**: 除固定百分比外，支援 **追蹤停損 (Trailing Stop)**
- **彈性訊號組合**: 自訂進出場條件
- **即時數據下載**: 自動從 Yahoo Finance 抓取數據
- **智慧快取機制**: 避免重複下載相同數據
- **完整績效分析**: 20+ 項績效指標
- **多維度視覺化**: 資金曲線、交易明細、月度熱力圖
- **買入持有比較**: 同時顯示策略 vs 基準表現


## 使用指南

### 步驟 1: 選擇模式

在儀表板上方選擇 **預設模式** 或 **自定義模式**。

### 步驟 2: 設定回測參數

#### 基本參數 (兩種模式通用)

| 參數 | 說明 | 範例 |
|------|------|------|
| 股票代碼 | Yahoo Finance 代碼 | `AAPL`, `2330`, `006208` |
| 開始日期 | 回測起始日 | `2020-01-01` |
| 結束日期 | 回測結束日 | `2024-12-31` |
| 初始資金 | 起始本金 | `100000` |
| 買入手續費 | 百分比 | `0.1425` (台股) |
| 賣出手續費 | 百分比 | `0.4425` (台股含證交稅) |

#### 預設模式參數

| 參數 | 預設值 | 說明 |
|------|--------|------|
| 短期均線 | 10 | 快速移動平均線週期 |
| 長期均線 | 60 | 慢速移動平均線週期 |
| 進場 RSI 週期 | 14 | 計算進場 RSI 的週期 |
| 進場 RSI 閾值 | 70 | RSI 低於此值才買進 |
| 出場 RSI 週期 | 14 | 計算出場 RSI 的週期 |
| 出場 RSI 閾值 | 80 | RSI 高於此值就賣出 |
| 停損百分比 | 0 | 0 表示不啟用 |
| 停利百分比 | 0 | 0 表示不啟用 |
| 追蹤停損百分比 | 0 | 0 表示不啟用 |



### 步驟 3: 分析結果

#### 績效指標區

| 指標 | 說明 |
|------|------|
| 總報酬率 | 策略整體獲利百分比 |
| 年化報酬率 | 換算成年化的報酬率 |
| 買入持有報酬 | 基準策略表現 |
| 最大回撤 | 最大虧損幅度 |
| 夏普比率 | 風險調整後報酬 (>1 為佳) |
| 勝率 | 獲利交易佔比 |
| 獲利因子 | 總獲利 / 總虧損 (>1 為佳) |
| 交易次數 | 總共進出場次數 |

#### 資金曲線圖

- **藍線**: 策略淨值
- **灰線**: 買入持有基準
- **互動功能**: 滑鼠懸停顯示詳細數值

#### 交易明細表

每筆交易的詳細記錄：
- 進場時間與價格
- 出場時間與價格
- 損益金額與百分比
- 持有天數

#### 月度報酬熱力圖

視覺化每個月的績效表現：
- 綠色: 正報酬
- 紅色: 負報酬
- 顏色深淺代表幅度

---

<!-- ## 心得總結

### 專案完成過程中的發現

#### 1. 策略參數的敏感性

**發現**: 均線週期的選擇對績效影響極大。

- **過短週期** (如 5/20): 產生過多假訊號，交易成本侵蝕獲利
- **過長週期** (如 50/200): 反應過慢，錯過最佳進場點
- **最佳平衡**: 10/60 組合，在靈敏度與穩定性之間取得平衡

**教訓**: 參數優化需要在「訊號品質」與「反應速度」之間權衡。

#### 2. RSI 過濾器的重要性

**發現**: 單純的均線交叉策略容易在趨勢末端追高。

- 加入 **RSI < 70** 進場條件後，勝率從 **48%** 提升至 **58%**
- **RSI > 80** 出場機制能在急漲後及時獲利了結

**教訓**: 多重確認機制可以有效提升策略穩健性。

#### 3. 回測數據的品質

**發現**: Yahoo Finance 的數據偶爾會有缺失或異常值。

**解決方案**:
```python
# 填補缺失值
df = df.ffill().bfill()

# 台股代碼需要加上後綴
ticker = "2330.TW"  # 台積電
```

**教訓**: 數據清洗是回測準確性的基礎。

#### 4. 交易成本的影響

**發現**: 24 次交易產生的手續費約佔總資金的 **0.48%**。

**影響**: 對長期績效有顯著影響，尤其是高頻策略。

**改進方向**: 加入「最小持有天數」限制，減少過度交易。

### 遇到的困難與解決方法

#### 困難 1: Pandas 版本相容性問題

**問題**: `backtesting.py` 使用了已棄用的 `pd.Series.iteritems()` 方法。

**錯誤訊息**:
```
AttributeError: 'Series' object has no attribute 'iteritems'
```

**解決方法**:
```python
# 在 main.py 開頭加入相容性補丁
if not hasattr(pd.Series, 'iteritems'):
    pd.Series.iteritems = pd.Series.items
```

**學習**: 開源套件的版本相容性需要特別注意。

#### 困難 2: NumPy 數值類型序列化

**問題**: 回測結果中的 `np.float64` 無法直接序列化為 JSON。

**錯誤訊息**:
```
TypeError: Object of type float64 is not JSON serializable
```

**解決方法**:
```python
def safe_num(value, decimal=2):
    if pd.isna(value) or np.isinf(value):
        return 0.0
    return round(float(value), decimal)
```

**學習**: 數據在前後端傳遞時需要統一型別。

#### 困難 3: 非同步下載數據時的阻塞

**問題**: `yfinance.download()` 是同步函數，會阻塞 FastAPI 的事件循環。

**現象**: 下載數據時整個伺服器無法回應其他請求。

**解決方法**:
```python
async def get_yfinance_data(ticker, start, end):
    loop = asyncio.get_event_loop()
    return await loop.run_in_executor(
        None, _download_from_yahoo, ticker, start, end
    )
```

**學習**: 在非同步框架中使用同步函數需要特別處理。

#### 困難 4: 前端圖表渲染效能

**問題**: 當回測數據超過 1000 筆時，Chart.js 渲染會變慢。

**解決方法**:
```javascript
// 使用 decimation 插件自動降採樣
plugins: {
  decimation: {
    enabled: true,
    algorithm: 'lttb'
  }
}
```

**學習**: 大數據視覺化需要考慮效能優化。

### 回測結果分析與看法

#### 測試標的: SPY (S&P 500 ETF)

**回測設定**:
- 回測區間: 2020-01-01 ~ 2024-12-31 (5 年)
- 初始資金: $100,000
- 手續費: 0.1%
- 策略: 雙均線 (10/60) + RSI 過濾 (70/80)

#### 主要績效指標

| 指標 | 策略表現 | 買入持有 | 差異 |
|------|----------|----------|------|
| 總報酬率 | +45.2% | +62.8% | -17.6% |
| 年化報酬 | +8.1% | +10.5% | -2.4% |
| 最大回撤 | -18.3% | -33.9% | **+15.6%**  |
| 夏普比率 | 0.82 | 0.65 | **+0.17**  |
| 勝率 | 58.3% | - | - |
| 交易次數 | 24 | 1 | - |

#### 深度分析

##### 1. 風險控制優於報酬追求

**觀察**: 策略的總報酬低於買入持有，但最大回撤僅 18.3%。

**意義**: 
- 在 2022 年熊市中，策略成功避開了 33.9% 的大幅回撤
- 這證明了趨勢追蹤策略的核心價值：**「在熊市中保護資本」**

**實務應用**: 對於風險承受度較低的投資人，這是更合適的選擇。

##### 2. 夏普比率的提升

**觀察**: 策略的夏普比率 (0.82) 高於買入持有 (0.65)。

**意義**: 
- 每承受 1 單位風險，策略獲得更高的報酬
- 風險調整後的績效更優

**公式**: 
```
夏普比率 = (年化報酬 - 無風險利率) / 年化波動率
```

##### 3. 交易成本的影響

**計算**: 
- 24 次交易 × 0.1% 手續費 = 約 0.48% 總成本
- 對 5 年總報酬的影響: 約 -1.2%

**改進方向**:
- 加入「最小持有天數」限制 (如 5 天)
- 提高進場訊號的門檻，減少假訊號

##### 4. 策略適用性分析

**表現優異的市場環境**:
- 2020-2021 牛市: 趨勢明確，策略表現優異
- 2023 反彈: 成功捕捉上漲趨勢

**表現不佳的市場環境**:
- 2022 震盪市: 多次假訊號，導致連續虧損
- 盤整期: 均線交叉頻繁，交易成本侵蝕獲利

**建議**: 加入「市場環境判斷」機制，在盤整期降低倉位或停止交易。

### 未來改進方向

#### 1. 多標的輪動機制 (Sector Rotation)

**概念**: 在不同產業間輪動，選擇相對強勢的標的。

**實作方向**:
```python
# 比較多個 ETF 的相對強度
sectors = ['XLK', 'XLF', 'XLE', 'XLV']  # 科技、金融、能源、醫療
# 每月重新平衡，持有最強的 2 個產業
```

#### 2. 結合基本面指標

**概念**: 用技術面決定「何時買」，用基本面決定「買什麼」。

**可用指標**:
- PE Ratio (本益比)
- PB Ratio (股價淨值比)
- ROE (股東權益報酬率)

#### 3. 動態停損 (Trailing Stop)

**概念**: 停損點隨著價格上漲而上移，鎖定獲利。

**實作**:
```python
# 當價格上漲 10% 後，停損點設在最高點的 -5%
if price > entry_price * 1.1:
    stop_loss = max_price * 0.95
```

#### 4. 倉位管理 (Position Sizing)

**概念**: 根據訊號強度調整買入比例。

**策略**:
- 強訊號 (多重確認): 買入 100%
- 弱訊號 (單一確認): 買入 50%
- 不確定訊號: 不買入

#### 5. 機器學習優化

**概念**: 使用 ML 模型預測最佳參數組合。

**工具**:
- Optuna: 超參數優化
- Walk-Forward Analysis: 避免過度擬合

### 學習收穫

#### 1. 量化思維的建立

**轉變**: 從「憑感覺操作」到「用數據驗證」。

**實例**:
- 以前: "我覺得這支股票會漲"
- 現在: "根據回測，這個策略在類似環境下勝率 58%"

#### 2. 全端開發能力

**技能樹**:
- **後端**: FastAPI, Pydantic, 非同步程式設計
- **數據**: Pandas, NumPy, 數據清洗
- **前端**: HTML/CSS/JavaScript, Chart.js
- **DevOps**: uv 套件管理, Git 版本控制

#### 3. 金融工程知識

**深入理解**:
- 技術指標的計算原理 (RSI 的 Wilder's Smoothing)
- 績效指標的意義 (夏普比率、最大回撤)
- 回測的陷阱 (過度擬合、前視偏誤)

#### 4. 專案管理經驗

**實踐**:
- 模組化設計 (app/, templates/, static/)
- 文件撰寫 (README.md, docstrings)
- 錯誤處理與除錯
- 使用者體驗優化

### 最大的收穫

> **「沒有完美的策略，只有適合的策略。」**

回測讓我們理解到：
- 策略需要根據市場環境調整
- 風險控制比追求報酬更重要
- 紀律執行比策略本身更關鍵

這些經驗不僅適用於量化交易，也適用於人生的各種決策。
 -->
---

## 參考資源

### 官方文件

- [Backtesting.py 官方文件](https://kernc.github.io/backtesting.py/)
- [FastAPI 官方文件](https://fastapi.tiangolo.com/)
- [Pydantic 官方文件](https://docs.pydantic.dev/)
- [Chart.js 官方文件](https://www.chartjs.org/)
- [uv 套件管理工具](https://github.com/astral-sh/uv)

### 學習資源

- [Pandas 官方教學](https://pandas.pydata.org/docs/user_guide/index.html)
- [NumPy 官方教學](https://numpy.org/doc/stable/user/index.html)
- [Yahoo Finance API](https://pypi.org/project/yfinance/)

### 量化交易相關

- [QuantConnect 教學](https://www.quantconnect.com/docs/)
- [Investopedia 技術分析](https://www.investopedia.com/technical-analysis-4689657)
- [TradingView 指標說明](https://www.tradingview.com/support/solutions/43000502344-about-technical-indicators-and-overlays/)

---

## 授權與免責聲明

### 授權

本專案採用 **MIT License**，僅供學術與教育用途。

### 免責聲明

**重要提醒**:

1. 本專案僅供學習與研究使用
2. **請勿用於實際交易決策**
3. 歷史績效不代表未來表現
4. 回測結果可能存在過度擬合
5. 實際交易會有滑價、流動性等額外風險
6. 投資有風險，決策需謹慎



